#!/usr/bin/env bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

state=
minutes=0
day=$(date +"%d/%m/%y")
# TODO: every file should be a date of this format and should store every session
echo "$day"

cleanup() {
  echo
  echo "Timer Closed! Start a new one now."

  if [[ -n $tloop_pid ]]; then
    kill "$tloop_pid"
  fi
}
trap cleanup EXIT

initial_prompt() {
  SUFFIX=".. minutes"

  printf "timer for %s" "$SUFFIX"

  tput cub "${#SUFFIX}"

  read -r minutes
  if [ -z $minutes ]; then
    echo "ERROR: Empty Input"
    exit 1
  fi
  echo $minutes > $SCRIPT_DIR/sessions/today
}

read_input() {
  pause=
  read -sn 1 pause

  if [ "$pause" = "p" ] 
    then
      t=$(cat $SCRIPT_DIR/sessions/today)
      kill "$tloop_pid"
      tloop_pid=
      echo
      echo "PAUSED AT $t! Press 's' to start."

      start=
      read -sn 1 start
      if [ "$start" = "s" ]
      then
        echo
        echo "Starting..."
        beg
      fi
  fi
}

tloop() {
  t=$(cat $SCRIPT_DIR/sessions/today)
  printf "\r$t minutes left"
  while [ $t -gt 0 ]; do
    sleep 1
    let "t-=1"
    text="$t minutes left"
    # echo -ne "\r$text"
    printf "\r$text"
    echo $t > $SCRIPT_DIR/sessions/today
  done

  printf "\nPress Enter to Close\n"
  paplay $SCRIPT_DIR/assets/sound.wav
  while sleep 3; do
    printf "Press Enter to Close\n"
  done
}

beg() {
  if [[ -n $tloop_pid ]]; then
    kill "$tloop_pid"
    tloop_pid=
  fi
  tloop_pid=
  tloop&
  tloop_pid=$!

  read_input
}

initial_prompt

beg
