#!/usr/bin/env bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
day=$(date +"%d.%m.%y")

SOUND_EFFECT="$SCRIPT_DIR/assets/bell.wav"

# Creating a tmp file
tmp_file=$(find $SCRIPT_DIR/sessions/ -name "tmp")
if [[ -z $tmp_file ]]; then
  touch "$SCRIPT_DIR/sessions/tmp"
  tmp_file=$(find $SCRIPT_DIR/sessions/ -name "tmp")
fi 

# Creating todays file
todays_file=$(find $SCRIPT_DIR/sessions/ -name $day) 
if [[ -z $todays_file ]]; then
  touch "$SCRIPT_DIR/sessions/$day"
  todays_file=$(find $SCRIPT_DIR/sessions/ -name $day)
  echo -e "Number of sessions: 0" > $todays_file
  echo -e "Total amount (in minutes): 0\n" >> $todays_file
fi 

number_of_sessions_today=$(head -n 1 $todays_file | awk 'NF>1{print $NF}')
# first_line_today=$(head -n 1 $todays_file)
# printf "n: $number_of_sessions_today"

printf "day: $day\n"


next=$(expr $number_of_sessions_today + 1)
echo "[SESSION $next]" >> $todays_file
echo "Started at $(date +"%d-%m-%4Y %T")" >> $todays_file

timer_total_amount=0


cleanup() {
  if [[ -n $minutes ]]; then
    printf "\n\nTimer Closed! Start a new one now.\n"
  fi

  if [[ -n $tloop_pid ]]; then
    kill "$tloop_pid"
  fi

  last_line_tmp=$(tail -n 1 $tmp_file)
  time_studied=$(expr $minutes - $last_line_tmp)

  printf "\nStudied for $time_studied minutes\n"

  next=$(expr $number_of_sessions_today + 1)
  next_number_of_sessions_today=$(head -n 1 $todays_file | awk -v var="$next" 'NF>1{$NF=var; print}')
  # echo $next_number_of_sessions_today > $todays_file 
  # head -n 1 $todays_file | awk -v var="$next" 'NF>1 && NR==1 {$NF=var}'
  awk -v var="$next" 'NF>1 && NR==1 {$NF=var}' $todays_file

  echo -e "$(sed -e "s/$(head -n 1 $todays_file)/${next_number_of_sessions_today}/g" $todays_file)\n" > $todays_file
  
  echo -e "Studied for $time_studied minutes\n" >> $todays_file


  current_amount_studied=$(head -n 2 $todays_file | awk 'NF>1 && NR==2{print $NF}')

  nextstudied=$(expr $current_amount_studied + $time_studied)

  next_amount_studied_today=$(head -n 2 $todays_file | awk -v var="$nextstudied" 'NF>1 && NR==2 {$NF=var; print}')
  echo -e "$(sed -e "s/$(head -n 2 $todays_file | tail -n 1)/${next_amount_studied_today}/g" $todays_file)\n" > $todays_file
}
trap cleanup EXIT

initial_prompt() {
  SUFFIX=".. minutes"

  printf "timer for %s" "$SUFFIX"

  tput cub "${#SUFFIX}"

  read -r minutes
  if [ -z $minutes ]; then
    printf "\nERROR: Empty Input\n"
    exit 1
  fi
  echo $minutes > $tmp_file
}

read_input() {
  pause=
  read -sn 1 pause

  if [ "$pause" = "p" ] || [ "$pause" = "P" ]
    then
      echo "Paused at $(date +"%d-%m-%4Y %T")" >> $todays_file
      t=$(tail -n 1 $tmp_file)
      kill "$tloop_pid"
      tloop_pid=
      printf "\n\nPAUSED AT $t! Press 's' to start."

      start=
      read -sn 1 start
      if [ "$start" = "s" ] || [ "$start" = "S" ]
      then
        printf "\nRestarting...\n"
        echo "Restarted at $(date +"%d-%m-%4Y %T")" >> $todays_file
        beg
      else 
        if [[ -n $start ]] && [ "$start" != "S" ] && [ "$start" != "s" ]
        then
          echo "Interrupted after $((minutes-t)) minute(s)" >> $todays_file
        fi
      fi

  else 
    if [[ -n $pause ]] && [ "$pause" != "P" ] && [ "$pause" != "p" ]
    then
      t=$(tail -n 1 $tmp_file)
      echo "Interrupted after $((minutes-t)) minute(s)" >> $todays_file
    fi
  fi
}

tloop() {
  t=$(tail -n 1 $tmp_file)
  printf "\n"
  printf "\r$t minutes left"
  # TODO: Change formatting to +%H:%M:%S
  while [ $t -gt 0 ]; do
    sleep 60
    let "t-=1"
    text="$t minutes left"
    printf "\r$text"
    echo $t >> $tmp_file
  done

  echo "Ended at $(date +"%d-%m-%4Y %T")" >> $todays_file

  notify-send "CLI Timer Ended!" "<i><span color='#ffffff'>Start another now!</span></i>"
  printf "\n\nTime is up!\n\nPress Enter to Close\n"
  paplay $SOUND_EFFECT
  while sleep 3; do
    printf "Press Enter to Close\n"
    paplay $SOUND_EFFECT
  done
}

beg() {
  if [[ -n $tloop_pid ]]; then
    kill "$tloop_pid"
    tloop_pid=
  fi
  tloop_pid=
  tloop&
  tloop_pid=$!

  read_input
}

initial_prompt

beg
